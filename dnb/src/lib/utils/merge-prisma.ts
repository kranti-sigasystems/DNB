// src/lib/utils/merge-prisma.ts
import fs from 'fs/promises';
import path from 'path';

console.log('üöÄ Starting Prisma schema merge...');

async function main() {
  try {
    const projectRoot = process.cwd();
    const modelDir = path.join(projectRoot, 'prisma/models');
    const outputFile = path.join(projectRoot, 'prisma/schema.prisma');

    console.log('üìÇ Project root:', projectRoot);
    console.log('üîç Model directory:', modelDir);
    
    // Ensure directories exist
    await fs.mkdir(path.dirname(outputFile), { recursive: true });
    await fs.mkdir(modelDir, { recursive: true });
    
    // Get .prisma files
    let files: string[] = [];
    try {
      files = await fs.readdir(modelDir);
    } catch (error) {
      console.log('üìÅ Created models directory');
    }
    
    const prismaFiles = files.filter((f: string) => f.endsWith('.prisma'));
    console.log(`üìÑ Found ${prismaFiles.length} .prisma files:`);
    
    if (prismaFiles.length === 0) {
      console.log('‚ùå No .prisma files found. Create files in prisma/models/');
      return;
    }
    
    // Display files
    prismaFiles.forEach(file => console.log(`  ‚Ä¢ ${file}`));
    
    // Build schema - WITHOUT import statements
    let schema = `// Auto-generated by merge-prisma.ts
// Generated: ${new Date().toISOString()}
// Models: ${prismaFiles.join(', ')}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url = env("DATABASE_URL") - Configure in PrismaClient instead
}

`;
    
    // Read and append each file's CONTENT (not import statements)
    for (const file of prismaFiles) {
      console.log(`  üìñ Reading: ${file}`);
      const filePath = path.join(modelDir, file);
      const content = await fs.readFile(filePath, 'utf-8');
      
      // Add separator and the actual model content
      schema += `\n// ========== ${file} ==========\n`;
      schema += content.trim() + '\n';
    }
    
    // Write to file
    await fs.writeFile(outputFile, schema, 'utf-8');
    console.log(`‚úÖ Created: ${outputFile}`);
    console.log('üëâ Next: Run "npx prisma generate"');
    
  } catch (error: any) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

// Execute
main();